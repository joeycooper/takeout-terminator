<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çº ç»“ç»ˆç»“è€… (Takeout Terminator) ğŸ¤–ğŸ±</title>
    <style>
        :root {
            --primary: #6366f1; --accent: #f43f5e; --bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); --text: #ffffff;
        }
        body.theme-krabs { --primary: #f59e0b; --accent: #b91c1c; --bg: #450a0a; --card-bg: rgba(251, 191, 36, 0.1); }
        body.theme-sponge { --primary: #fbbf24; --accent: #ea580c; --bg: #78350f; --card-bg: rgba(254, 240, 138, 0.1); }

        body {
            margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease;
            position: relative;
        }

        /* åŠ¨æ€èƒŒæ™¯æ°”æ³¡ */
        .bubble { position: absolute; background: rgba(255,255,255,0.05); border-radius: 50%; bottom: -100px; animation: rise 15s infinite ease-in; z-index: -1; }
        @keyframes rise { from { bottom: -100px; transform: translateX(0); } to { bottom: 110%; transform: translateX(50px); } }

        .container {
            text-align: center; padding: 1.5rem; background: var(--card-bg); backdrop-filter: blur(20px);
            border-radius: 2.5rem; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8); max-width: 400px; width: 85%; position: relative;
        }

        .top-bar { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.7rem; color: #94a3b8; }
        .weather-info { color: #818cf8; font-weight: bold; cursor: pointer; }

        h1 {
            font-size: 1.6rem; margin-bottom: 0.5rem;
            background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-weight: 900; letter-spacing: -1px;
        }

        .mode-selector { display: flex; gap: 0.3rem; justify-content: center; margin-bottom: 1.2rem; }
        .mode-btn { padding: 0.4rem 0.7rem; font-size: 0.75rem; border-radius: 0.7rem; border: 1px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; transition: 0.3s; }
        .mode-btn.active { background: var(--primary); color: white; box-shadow: 0 0 15px var(--primary); }

        .slot-machine {
            height: 110px; overflow: hidden; background: rgba(0, 0, 0, 0.4); border-radius: 1.5rem;
            border: 3px solid var(--primary); position: relative; margin-bottom: 1.5rem;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }
        .slot-container { position: absolute; width: 100%; transition: transform 3s cubic-bezier(0.15, 0, 0.05, 1); }
        .slot-item { height: 110px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; font-weight: 800; text-shadow: 0 0 10px rgba(255,255,255,0.3); }

        #spin-btn {
            padding: 1.1rem; font-size: 1.3rem; font-weight: 800; background: var(--primary); color: white;
            border: none; border-radius: 1.2rem; cursor: pointer; width: 100%; box-shadow: 0 10px 20px -5px var(--primary);
            transition: 0.2s active;
        }
        #spin-btn:active { transform: scale(0.98); opacity: 0.9; }

        .advice-box { 
            margin-top: 1.2rem; padding: 1.2rem; background: rgba(0, 0, 0, 0.3); border-radius: 1.2rem; 
            font-style: normal; font-size: 0.9rem; color: #e2e8f0; display: none; border: 1px dashed var(--primary);
            line-height: 1.5;
        }
        
        .platform-section { display: none; margin-top: 1.5rem; }
        .platform-grid { display: flex; gap: 0.5rem; margin-bottom: 1.2rem; }
        .platform-btn { padding: 0.8rem 0.4rem; font-size: 0.85rem; border-radius: 0.8rem; border: none; color: white; cursor: pointer; flex: 1; font-weight: bold; }

        .action-bar { display: flex; gap: 0.5rem; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.7rem; border-radius: 0.8rem; font-size: 0.8rem; cursor: pointer; flex: 1; border: 1px solid rgba(255,255,255,0.05); }

        /* Cloud Sync Banner */
        #sync-banner {
            position: fixed; bottom: 20px; width: 90%; max-width: 360px; background: var(--primary);
            color: white; padding: 1rem; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; justify-content: space-between; align-items: center; z-index: 200;
        }

        #edit-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            display: none; align-items: center; justify-content: center; z-index: 300;
        }
        .modal-content { background: #1e293b; padding: 1.5rem; border-radius: 2rem; width: 85%; max-width: 350px; border: 1px solid var(--primary); }
        textarea { width: 100%; height: 200px; background: #0f172a; color: white; border: 1px solid var(--primary); border-radius: 1rem; padding: 1rem; margin: 1rem 0; font-size: 1rem; box-sizing: border-box; }

        .theme-switcher { position: absolute; top: -45px; right: 0; display: flex; gap: 0.8rem; }
        .theme-dot { width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .shake-hint { font-size: 0.7rem; color: #64748b; margin-top: 0.8rem; letter-spacing: 1px; }
    </style>
</head>
<body class="theme-pi">
    <!-- èƒŒæ™¯æ°”æ³¡ -->
    <div id="bubbles"></div>

    <div class="container">
        <div class="theme-switcher">
            <div class="theme-dot" style="background: #6366f1;" onclick="setTheme('pi')"></div>
            <div class="theme-dot" style="background: #f59e0b;" onclick="setTheme('krabs')"></div>
            <div class="theme-dot" style="background: #fbbf24;" onclick="setTheme('sponge')"></div>
        </div>

        <div class="top-bar">
            <span id="weather-text" class="weather-info" onclick="detectCity()">ğŸ” æ¢æµ‹ä½ç½®...</span>
            <span id="meal-time">æ¯”å¥‡å ¡æ—¶é—´</span>
        </div>

        <h1>çº ç»“ç»ˆç»“è€… ğŸš€</h1>

        <div class="mode-selector">
            <button class="mode-btn active" id="mode-all" onclick="setMode('all')">å…¨éƒ½è¦</button>
            <button class="mode-btn" id="mode-fit" onclick="setMode('fit')">è¦èº«æ</button>
            <button class="mode-btn" id="mode-night" onclick="setMode('night')">è¦å¿«ä¹</button>
        </div>
        
        <div class="slot-machine">
            <div id="slot-container" class="slot-container"></div>
        </div>

        <button id="spin-btn" onclick="spin()">å¼€å§‹ç‚¹å°† / æ‘‡ä¸€æ‘‡</button>
        <div class="shake-hint">ç”¨åŠ›ç”©åŠ¨æ‰‹æœºä¹Ÿå¯ä»¥è§¦å‘ï¼</div>
        
        <div id="advice" class="advice-box"></div>

        <div id="order-section" class="platform-section">
            <div class="platform-grid">
                <button class="platform-btn" onclick="openApp('ele')" style="background: linear-gradient(to right, #008cff, #ff5000);">é¥¿äº†ä¹ˆ/æ·˜å®</button>
                <button class="platform-btn" onclick="openApp('meituan')" style="background: #ffc300; color: #000;">ç¾å›¢å¤–å–</button>
                <button class="platform-btn" onclick="openApp('dianping')" style="background: #ff6633;">å¤§ä¼—ç‚¹è¯„</button>
            </div>
            <div class="action-bar">
                <button class="icon-btn" onclick="openEdit()">âœï¸ ä¿®æ”¹èœå•</button>
                <button class="icon-btn" onclick="shareResult()">ğŸ“¤ åˆ†äº«æˆ˜æœ</button>
            </div>
        </div>
        
        <div class="footer">ç”±æ´¾å¤§æ˜Ÿå¤§å°†å†›è£èª‰å‡ºå“ ğŸ«¡</div>
    </div>

    <!-- ä¿å­˜äº‘ç«¯å¼¹çª— -->
    <div id="sync-banner">
        <span style="font-size: 0.8rem; font-weight: bold;">å¤§å°†å†›å‘ç°ä½ å¾ˆæœ‰çœ¼å…‰ï¼<br/>è¦åˆ›å»ºä¸“å±ç§äººèœå•å—ï¼Ÿ</span>
        <button onclick="requestCloudSync()" style="background: white; color: var(--primary); border: none; padding: 0.5rem 0.8rem; border-radius: 0.5rem; font-weight: bold; font-size: 0.7rem;">ç‚¹æˆ‘åˆ›å»º</button>
    </div>

    <div id="edit-modal" onclick="closeEdit(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 id="edit-title">ç¼–è¾‘èœå•</h3>
            <textarea id="menu-edit-area"></textarea>
            <button id="spin-btn" style="padding: 0.8rem;" onclick="saveMenu()">åŒæ­¥åˆ°äº‘ç«¯</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type; osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }

        // åˆå§‹åŒ–ç”¨æˆ·ID
        let userId = localStorage.getItem('terminator_user_id') || 'guest_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('terminator_user_id', userId);

        let menus = {
            all: ["ğŸ” æ±‰å ¡è–¯æ¡", "ğŸœ å…°å·æ‹‰é¢", "ğŸ± ç²¾è‡´æ—¥æ–™", "ğŸ› å’–å–±é¥­", "ğŸ¥˜ éº»è¾£çƒ«", "ğŸ— éŸ©å¼ç‚¸é¸¡", "ğŸ¥— å¥åº·æ²™æ‹‰", "ğŸ æ„å¼é¢ç‚¹", "ğŸ¥¡ å¹¿å¼ç‚¹å¿ƒ", "ğŸ¢ ä¸œåŒ—çƒ§çƒ¤", "ğŸ² æš–å¿ƒå°ç«é”…", "ğŸš ç…²ä»”é¥­"],
            fit: ["ğŸ¥— é¸¡èƒ¸è‚‰æ²™æ‹‰", "ğŸ¥£ ä½è„‚ç‡•éº¦", "ğŸ£ åˆºèº«æ‹¼ç›˜", "ğŸ¥ª å…¨éº¦ä¸‰æ˜æ²»", "ğŸµ çº¯å‡€æœè”¬æ±", "ğŸ² æ¸…è’¸é±¼ç‰‡"],
            night: ["ğŸ¢ ç‹‚é‡çƒ§çƒ¤", "ğŸ¥˜ åŠ²çˆ†å°é¾™è™¾", "ğŸ— ç‚¸é¸¡å•¤é…’", "ğŸœ èºè›³ç²‰", "ğŸŸ å¤§ä»½è–¯æ¡", "ğŸ¥¨ è„†çš®äº”èŠ±è‚‰"]
        };

        const advicesPool = [
            "è¥¿æ¹–çš„é£ï¼Œå¹ä¸åˆ°æˆ‘çš„èƒƒï¼Œä½†å¤§å°†å†›å¯ä»¥ã€‚",
            "æ²¡æœ‰ä»€ä¹ˆæ˜¯ä¸€é¡¿é¥­è§£å†³ä¸äº†çš„ï¼Œå¦‚æœæœ‰ï¼Œå°±ä¸¤é¡¿ã€‚",
            "å¤§å°†å†›å¾¡ç¬”ï¼šä»Šå¤©ä½ çš„èƒƒå€¼å¾—æ¸©æŸ”ä»¥å¾…ã€‚",
            "åœ¨æ¯ä¸€ä¸ªçº ç»“çš„ç¬é—´ï¼Œéƒ½æœ‰å¤§å°†å†›ä¸ºä½ æ’‘è…°ã€‚",
            "ç”Ÿæ´»å¤ªè‹¦ï¼Œç‚¹é¤è¦é…·ã€‚",
            "æ­åŸçš„çƒŸç«æ°”ï¼Œæ­¤åˆ»å°±åœ¨ä½ çš„æŒ‡å°–ã€‚",
            "æŠ“æ°´æ¯ä¸å¦‚æŠ“ç­·å­ï¼Œå¤§å°†å†›çœ‹å¥½ä½ ï¼",
            "è¿™æ˜¯å‘½è¿çš„å®‰æ’ï¼Œä¹Ÿæ˜¯å¤§å°†å†›çš„æ—¨æ„ã€‚"
        ];

        let spinCount = parseInt(localStorage.getItem('spin_count') || '0');
        let history = JSON.parse(localStorage.getItem('takeout_history')) || [];
        let currentMode = 'all';
        let lastWinner = "";
        let currentWinner = "";
        let currentCityId = "3"; // é»˜è®¤æ­å·

        const container = document.getElementById('slot-container');
        const spinBtn = document.getElementById('spin-btn');
        const adviceBox = document.getElementById('advice');
        const orderSection = document.getElementById('order-section');

        // ç”ŸæˆèƒŒæ™¯æ°”æ³¡
        function createBubbles() {
            const wrap = document.getElementById('bubbles');
            for(let i=0; i<10; i++) {
                const b = document.createElement('div');
                b.className = 'bubble';
                const size = Math.random() * 60 + 20;
                b.style.width = size + 'px'; b.style.height = size + 'px';
                b.style.left = Math.random() * 100 + '%';
                b.style.animationDelay = Math.random() * 10 + 's';
                wrap.appendChild(b);
            }
        }
        createBubbles();

        async function fetchMenus() {
            try {
                const res = await fetch('/api/menus', { headers: { 'X-User-Id': userId } });
                if (res.ok) {
                    menus = await res.json();
                    initList();
                }
            } catch (e) { initList(); }
        }

        function initList() {
            container.innerHTML = '';
            const list = menus[currentMode];
            const displayList = [...list, ...list, ...list];
            displayList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'slot-item'; div.textContent = item;
                container.appendChild(div);
            });
            container.style.transition = 'none';
            container.style.transform = `translateY(0)`;
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            initList();
        }

        function setTheme(theme) { document.body.className = `theme-${theme}`; }

        function spin() {
            // iOS æ‘‡ä¸€æ‘‡æƒé™è¯·æ±‚å¿…é¡»ç”±ç”¨æˆ·è§¦å‘
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') { console.log("Shake activated"); }
                });
            }

            if (spinBtn.disabled) return;
            const list = menus[currentMode];
            let randomIndex = Math.floor(Math.random() * list.length);
            let winner = list[randomIndex];

            if (winner === lastWinner && list.length > 1) {
                adviceBox.innerHTML = '<b style="color:var(--accent)">å¤§å°†å†›ä¸ç­”åº”ï¼è¿åƒä¸¤æ¬¡å¤ªè…»äº†ï¼Œé‡æŠ½ï¼</b>';
                adviceBox.style.display = 'block';
                playSound(150, 'square', 0.2);
                return;
            }

            spinBtn.disabled = true; orderSection.style.display = 'none'; adviceBox.style.display = 'none';
            
            let count = 0;
            const clicker = setInterval(() => {
                playSound(400 + Math.random() * 200, 'sine', 0.05);
                if (++count > 25) clearInterval(clicker);
            }, 80);

            const itemHeight = 110;
            const targetOffset = (list.length * 2 + randomIndex) * itemHeight;
            container.style.transition = 'transform 3s cubic-bezier(0.15, 0, 0.05, 1)';
            container.style.transform = `translateY(-${targetOffset}px)`;
            
            setTimeout(() => {
                spinBtn.disabled = false; lastWinner = winner;
                currentWinner = winner.replace(/[\u{1F300}-\u{1F9FF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
                playSound(800, 'sine', 0.1); setTimeout(()=>playSound(1200, 'sine', 0.15), 100);
                
                spinCount++; localStorage.setItem('spin_count', spinCount);
                if (spinCount === 3 && userId.startsWith('guest_')) {
                    document.getElementById('sync-banner').style.display = 'flex';
                }

                let adviceText = advicesPool[Math.floor(Math.random() * advicesPool.length)];
                const countInHistory = history.filter(h => h.w === winner).length;
                if(countInHistory > 2) adviceText = `ç« é±¼å“¥ï¼ç¬¬${countInHistory+1}æ¬¡é€‰å®ƒäº†ï¼Œè…¹è‚Œåœ¨å“­æ³£ï¼ğŸ˜­`;
                
                adviceBox.textContent = adviceText;
                adviceBox.style.display = 'block';
                orderSection.style.display = 'block';

                history.push({t: Date.now(), w: winner});
                if(history.length > 20) history.shift();
                localStorage.setItem('takeout_history', JSON.stringify(history));

                setTimeout(() => {
                    container.style.transition = 'none';
                    container.style.transform = `translateY(-${randomIndex * itemHeight}px)`;
                }, 500);
            }, 3000);
        }

        // æ‘‡ä¸€æ‘‡ä¼˜åŒ–
        let lastShake = 0;
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            const threshold = 15;
            if (Math.abs(acc.x) > threshold || Math.abs(acc.y) > threshold) {
                if (Date.now() - lastShake > 4000) {
                    lastShake = Date.now();
                    spin();
                }
            }
        });

        function openEdit() {
            document.getElementById('edit-title').textContent = `ç¼–è¾‘ã€${currentMode}ã€‘èœå•`;
            document.getElementById('menu-edit-area').value = menus[currentMode].join('\n');
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEdit(e) { document.getElementById('edit-modal').style.display = 'none'; }
        function saveMenu() {
            menus[currentMode] = document.getElementById('menu-edit-area').value.split('\n').filter(i => i.trim());
            fetch('/api/menus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-User-Id': userId },
                body: JSON.stringify(menus)
            });
            initList(); closeEdit();
        }

        function requestCloudSync() {
            const name = prompt("è¯·è¾“å…¥ä½ çš„ä¸“å±ä»£å·ï¼ˆå¤§å°†å†›å°†ä»¥æ­¤åè®°ä½ä½ çš„å£å‘³ï¼‰ï¼š");
            if(name) {
                userId = name;
                localStorage.setItem('terminator_user_id', userId);
                document.getElementById('sync-banner').style.display = 'none';
                fetchMenus();
                alert(`æ¬¢è¿åŠ å…¥æ¯”å¥‡å ¡ï¼Œ${userId} å¤§å°†å†›ï¼æ•°æ®æ­£åœ¨åŒæ­¥...`);
            }
        }

        function detectCity() {
            if (navigator.geolocation) {
                document.getElementById('weather-text').textContent = "ğŸ“¡ æ­£åœ¨å®šä½...";
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    // ç”±äºæ²¡æœ‰å¤©æ°”APIï¼Œè¿™é‡Œåšä¸€ä¸ªè§†è§‰ä¼ªè£…ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šç”¨ç»çº¬åº¦æŸ¥åŸå¸‚
                    document.getElementById('weather-text').textContent = "ğŸ“ å·²è‡ªåŠ¨å®šä½";
                    setTimeout(()=> { document.getElementById('weather-text').textContent = "ğŸŒ¤ï¸ æ­å·: 6Â°C"; }, 2000);
                }, () => {
                    alert("å®šä½å¤±è´¥ï¼Œè¯·ç¡®ä¿ç»™äº†å¤§å°†å†› GPS æƒé™ï¼");
                });
            }
        }

        function shareResult() {
            const text = `å¤§å°†å†›å¾¡ç¬”ç‚¹å°†ï¼šä»Šæ™šåƒã€${lastWinner}ã€‘ï¼è°èµæˆï¼Ÿè°åå¯¹ï¼ŸğŸ‘¾ğŸ™\n\nç›´è¾¾çº ç»“ç»ˆç»“è€…: ${window.location.href}`;
            if (navigator.share) {
                navigator.share({ title: 'ç‚¹é¤ç»“æœ', text: text });
            } else {
                const input = document.createElement('textarea');
                input.value = text; document.body.appendChild(input); input.select();
                document.execCommand('copy'); document.body.removeChild(input);
                alert("å·²å°†â€˜ç‚¹å°†ä»¤â€™å­˜å…¥å‰ªè´´æ¿ï¼è¯·ç›´æ¥ç²˜è´´å‘ç»™å¾®ä¿¡å¥½å‹ã€‚ğŸš€");
            }
        }

        function openApp(type) {
            const query = encodeURIComponent(currentWinner);
            let h5Url, appUrl;
            if (type === 'ele') { h5Url = `https://h5.ele.me/minisearch/result?keyword=${query}`; appUrl = `eleme://search?keyword=${query}`; }
            else if (type === 'meituan') { h5Url = `https://h5.waimai.meituan.com/waimai/mindex/searchresults?keyword=${query}`; appUrl = `imeituan://www.meituan.com/s/${query}`; }
            else { h5Url = `https://m.dianping.com/shoplist/${currentCityId}/search?keyword=${query}`; appUrl = `dianping://searchshoplist?keyword=${query}`; }
            window.open(appUrl, '_blank');
            setTimeout(() => { if (!document.hidden) window.location.href = h5Url; }, 2500);
        }

        const hour = new Date().getHours();
        document.getElementById('meal-time').textContent = hour < 10 ? "æ—©é¤æ—¶é—´" : hour < 14 ? "åˆé¤æ—¶é—´" : hour < 17 ? "ä¸‹åˆèŒ¶æ—¶é—´" : hour < 21 ? "æ™šé¤æ—¶é—´" : "å¤œå®µæ—¶é—´";
        fetchMenus();
    </script>
</body>
</html>
