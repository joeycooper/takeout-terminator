<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç« é±¼å“¥çš„é¤ç‚¹æ‹¯æ•‘è€… - 11.0 ä¿®å¤ç‰ˆ ğŸ‘¾</title>
    <style>
        :root {
            --primary: #6366f1; --accent: #f43f5e; --bg: #0f172a; --card-bg: rgba(255, 255, 255, 0.05); --text: #ffffff;
        }
        body.theme-krabs { --primary: #f59e0b; --accent: #b91c1c; --bg: #450a0a; --card-bg: rgba(251, 191, 36, 0.1); }
        body.theme-sponge { --primary: #fbbf24; --accent: #ea580c; --bg: #78350f; --card-bg: rgba(254, 240, 138, 0.1); }

        body {
            margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease;
        }

        .container {
            text-align: center; padding: 1.5rem; background: var(--card-bg); backdrop-filter: blur(15px);
            border-radius: 2rem; border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); max-width: 400px; width: 85%; position: relative;
        }

        .top-bar { display: flex; justify-content: space-between; margin-bottom: 0.8rem; font-size: 0.7rem; color: #94a3b8; }
        .weather-info { color: #818cf8; font-weight: bold; }

        h1 {
            font-size: 1.4rem; margin-bottom: 1rem;
            background: linear-gradient(to right, #818cf8, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .mode-selector { display: flex; gap: 0.3rem; justify-content: center; margin-bottom: 1rem; }
        .mode-btn { padding: 0.4rem 0.6rem; font-size: 0.7rem; border-radius: 0.5rem; border: 1px solid var(--primary); background: transparent; color: var(--primary); cursor: pointer; }
        .mode-btn.active { background: var(--primary); color: white; }

        .slot-machine {
            height: 90px; overflow: hidden; background: rgba(0, 0, 0, 0.3); border-radius: 1rem;
            border: 2px solid var(--primary); position: relative; margin-bottom: 1.5rem;
        }
        .slot-container { position: absolute; width: 100%; transition: transform 3s cubic-bezier(0.1, 0, 0.1, 1); }
        .slot-item { height: 90px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold; }

        #spin-btn {
            padding: 0.8rem; font-size: 1.1rem; font-weight: 600; background: var(--primary); color: white;
            border: none; border-radius: 1rem; cursor: pointer; width: 100%; box-shadow: 0 8px 15px -3px rgba(99, 102, 241, 0.4);
        }

        .advice-box { margin-top: 1.2rem; padding: 0.8rem; background: rgba(0, 0, 0, 0.2); border-radius: 1rem; font-style: italic; font-size: 0.85rem; color: #cbd5e1; display: none; }
        
        .platform-section { display: none; margin-top: 1rem; }
        .platform-grid { display: flex; gap: 0.4rem; margin-bottom: 1rem; }
        .platform-btn { padding: 0.6rem 0.4rem; font-size: 0.75rem; border-radius: 0.5rem; border: none; color: white; cursor: pointer; flex: 1; }

        .action-bar { display: flex; gap: 0.5rem; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 0.5rem; font-size: 0.8rem; cursor: pointer; flex: 1; }

        #edit-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content { background: #1e293b; padding: 2rem; border-radius: 1.5rem; width: 80%; max-width: 350px; }
        textarea { width: 100%; height: 150px; background: #0f172a; color: white; border: 1px solid var(--primary); border-radius: 0.5rem; padding: 0.5rem; margin: 1rem 0; font-size: 1rem; }

        .theme-switcher { position: absolute; top: -35px; right: 0; display: flex; gap: 0.5rem; }
        .theme-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid white; cursor: pointer; }
        
        .shake-hint { font-size: 0.6rem; color: #64748b; margin-top: 0.5rem; }
        .dupe-alert { color: var(--accent); font-weight: bold; }
    </style>
</head>
<body class="theme-pi">
    <div class="container">
        <div class="theme-switcher">
            <div class="theme-dot" style="background: #6366f1;" onclick="setTheme('pi')"></div>
            <div class="theme-dot" style="background: #f59e0b;" onclick="setTheme('krabs')"></div>
            <div class="theme-dot" style="background: #fbbf24;" onclick="setTheme('sponge')"></div>
        </div>

        <div class="top-bar">
            <span id="weather-text" class="weather-info">ğŸŒ¤ï¸ æ­å·: 6Â°C</span>
            <span id="meal-time">å¾…å‘½æ—¶é—´</span>
        </div>

        <h1 id="main-title">é¤ç‚¹æ‹¯æ•‘è€… 11.0</h1>

        <div class="mode-selector">
            <button class="mode-btn active" id="mode-all" onclick="setMode('all')">å…¨éƒ½è¦</button>
            <button class="mode-btn" id="mode-fit" onclick="setMode('fit')">è¦èº«æ</button>
            <button class="mode-btn" id="mode-night" onclick="setMode('night')">è¦å¿«ä¹</button>
        </div>
        
        <div class="slot-machine">
            <div id="slot-container" class="slot-container"></div>
        </div>

        <button id="spin-btn" onclick="spin()">å¼€å§‹ç‚¹å°† / æ‘‡ä¸€æ‘‡</button>
        <div class="shake-hint">ç”¨åŠ›ç”©åŠ¨æ‰‹æœºä¹Ÿå¯ä»¥è§¦å‘ï¼</div>
        
        <div id="advice" class="advice-box"></div>

        <div id="order-section" class="platform-section">
            <div class="platform-grid">
                <button class="platform-btn" onclick="openApp('ele')" style="background: linear-gradient(to right, #008cff, #ff5000);">é¥¿äº†ä¹ˆ/æ·˜å®</button>
                <button class="platform-btn" onclick="openApp('meituan')" style="background: #ffc300; color: #000;">ç¾å›¢å¤–å–</button>
                <button class="platform-btn" onclick="openApp('dianping')" style="background: #ff6633;">å¤§ä¼—ç‚¹è¯„</button>
            </div>
            <div class="action-bar">
                <button class="icon-btn" onclick="openEdit()">âœï¸ ç¼–è¾‘èœå•</button>
                <button class="icon-btn" onclick="shareResult()">ğŸ“¤ åˆ†äº«æˆ˜æœ</button>
            </div>
        </div>
        
        <div class="footer">ç”±æ´¾å¤§æ˜Ÿå¤§å°†å†›è£èª‰å‡ºå“ ğŸ«¡</div>
    </div>

    <div id="edit-modal" onclick="closeEdit(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3>ç¼–è¾‘èœå•</h3>
            <textarea id="menu-edit-area"></textarea>
            <button id="spin-btn" onclick="saveMenu()">ä¿å­˜ä¿®æ”¹</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(freq, type, duration) {
            try {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type; osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(); osc.stop(audioCtx.currentTime + duration);
            } catch(e) {}
        }

        let menus = {
            all: ["ğŸ” æ±‰å ¡è–¯æ¡", "ğŸœ å…°å·æ‹‰é¢", "ğŸ± ç²¾è‡´æ—¥æ–™", "ğŸ› å’–å–±é¥­", "ğŸ¥˜ éº»è¾£çƒ«", "ğŸ— éŸ©å¼ç‚¸é¸¡", "ğŸ¥— å¥åº·æ²™æ‹‰", "ğŸ æ„å¼é¢ç‚¹", "ğŸ¥¡ å¹¿å¼ç‚¹å¿ƒ", "ğŸ¢ ä¸œåŒ—çƒ§çƒ¤", "ğŸ² æš–å¿ƒå°ç«é”…", "ğŸš ç…²ä»”é¥­", "ğŸ¥Ÿ æ­å·å°ç¬¼åŒ…", "ğŸœ ç‰‡å„¿å·", "ğŸ² è¥¿æ¹–ç‰›è‚‰ç¾¹"],
            fit: ["ğŸ¥— é¸¡èƒ¸è‚‰æ²™æ‹‰", "ğŸ¥£ ä½è„‚ç‡•éº¦", "ğŸ£ åˆºèº«æ‹¼ç›˜", "ğŸ¥ª å…¨éº¦ä¸‰æ˜æ²»", "ğŸµ çº¯å‡€æœè”¬æ±", "ğŸ² æ¸…è’¸é±¼ç‰‡"],
            night: ["ğŸ¢ ç‹‚é‡çƒ§çƒ¤", "ğŸ¥˜ åŠ²çˆ†å°é¾™è™¾", "ğŸ— ç‚¸é¸¡å•¤é…’", "ğŸœ èºè›³ç²‰", "ğŸŸ å¤§ä»½è–¯æ¡", "ğŸ¥¨ è„†çš®äº”èŠ±è‚‰"]
        };

        let history = JSON.parse(localStorage.getItem('takeout_history')) || [];
        let currentMode = 'all';
        let lastWinner = "";
        let currentWinner = "";

        const container = document.getElementById('slot-container');
        const spinBtn = document.getElementById('spin-btn');
        const adviceBox = document.getElementById('advice');
        const orderSection = document.getElementById('order-section');

        async function fetchMenus() {
            try {
                const res = await fetch('/api/menus');
                if (res.ok) {
                    menus = await res.json();
                    initList();
                }
            } catch (e) {
                const saved = localStorage.getItem('takeout_menus');
                if(saved) menus = JSON.parse(saved);
                initList();
            }
        }

        function initList() {
            container.innerHTML = '';
            const list = menus[currentMode];
            const displayList = [...list, ...list, ...list];
            displayList.forEach(item => {
                const div = document.createElement('div');
                div.className = 'slot-item';
                div.textContent = item;
                container.appendChild(div);
            });
            container.style.transition = 'none';
            container.style.transform = `translateY(0)`;
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('mode-' + mode).classList.add('active');
            initList();
        }

        function setTheme(theme) { document.body.className = `theme-${theme}`; }

        function spin() {
            if (spinBtn.disabled) return;
            const list = menus[currentMode];
            let randomIndex = Math.floor(Math.random() * list.length);
            let winner = list[randomIndex];

            if (winner === lastWinner && list.length > 1) {
                adviceBox.innerHTML = '<span class="dupe-alert">å¤§å°†å†›ä¸ç­”åº”ï¼è¿åƒä¸¤æ¬¡å¤ªè…»äº†ï¼Œé‡æŠ½ï¼</span>';
                adviceBox.style.display = 'block';
                playSound(150, 'square', 0.2);
                return;
            }

            spinBtn.disabled = true;
            orderSection.style.display = 'none';
            adviceBox.style.display = 'none';
            
            let count = 0;
            const clicker = setInterval(() => {
                playSound(400 + Math.random() * 200, 'sine', 0.05);
                if (++count > 20) clearInterval(clicker);
            }, 100);

            const itemHeight = 90;
            const targetOffset = (list.length * 2 + randomIndex) * itemHeight;
            container.style.transition = 'transform 3s cubic-bezier(0.1, 0, 0.1, 1)';
            container.style.transform = `translateY(-${targetOffset}px)`;
            
            setTimeout(() => {
                spinBtn.disabled = false;
                lastWinner = winner;
                currentWinner = winner.replace(/[\u{1F300}-\u{1F9FF}]|[\u{1F600}-\u{1F64F}]|[\u{1F680}-\u{1F6FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}]/gu, '').trim();
                
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                playSound(800, 'sine', 0.1);
                
                let adviceText = "å¤§å°†å†›å»ºè®®ï¼šç¬¬ä¸€çœ¼é€‰ä¸­çš„å°±æ˜¯ç¼˜åˆ†ï¼";
                const countInHistory = history.filter(h => h.w === winner).length;
                if(countInHistory > 2) adviceText = `ç« é±¼å“¥ï¼è¿™å‘¨ç¬¬${countInHistory+1}æ¬¡é€‰å®ƒäº†ï¼Œä½ çš„è…¹è‚Œåœ¨å“­æ³£ï¼ğŸ˜­`;
                if(winner.includes("ç«é”…") || winner.includes("æ±¤") || winner.includes("é¢")) adviceText += " (å¤–é¢å†·ï¼Œåƒè¿™ä¸ªæš–å’Œï¼ğŸŒ¡ï¸)";

                adviceBox.textContent = adviceText;
                adviceBox.style.display = 'block';
                orderSection.style.display = 'block';

                history.push({t: Date.now(), w: winner});
                if(history.length > 20) history.shift();
                localStorage.setItem('takeout_history', JSON.stringify(history));

                setTimeout(() => {
                    container.style.transition = 'none';
                    container.style.transform = `translateY(-${randomIndex * itemHeight}px)`;
                }, 500);
            }, 3000);
        }

        let lastShake = 0;
        window.addEventListener('devicemotion', (e) => {
            const acc = e.accelerationIncludingGravity;
            if(!acc) return;
            const total = Math.abs(acc.x) + Math.abs(acc.y) + Math.abs(acc.z);
            if (total > 30 && Date.now() - lastShake > 5000) {
                lastShake = Date.now();
                spin();
            }
        });

        function openEdit() {
            document.getElementById('menu-edit-area').value = menus[currentMode].join('\n');
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEdit(e) { document.getElementById('edit-modal').style.display = 'none'; }
        function saveMenu() {
            const newMenus = document.getElementById('menu-edit-area').value.split('\n').filter(i => i.trim());
            menus[currentMode] = newMenus;
            fetch('/api/menus', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(menus)
            });
            localStorage.setItem('takeout_menus', JSON.stringify(menus));
            initList();
            closeEdit();
        }

        function shareResult() {
            const text = `å¤§å°†å†›å¾¡ç¬”ç‚¹å°†ï¼šä»Šæ™šåƒã€${lastWinner}ã€‘ï¼è°èµæˆï¼Ÿè°åå¯¹ï¼ŸğŸ‘¾ğŸ™`;
            if (navigator.share) {
                navigator.share({ title: 'ç‚¹é¤ç»“æœ', text: text, url: window.location.href });
            } else {
                const input = document.createElement('textarea');
                input.value = text + "\nç›´è¾¾å…‰ç¼†: " + window.location.href;
                document.body.appendChild(input); input.select();
                document.execCommand('copy'); document.body.removeChild(input);
                alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·ç›´æ¥å‘ç»™å¾®ä¿¡å¥½å‹ã€‚ğŸš€");
            }
        }

        function openApp(type) {
            const query = encodeURIComponent(currentWinner);
            let h5Url, appUrl;
            if (type === 'ele') { h5Url = `https://h5.ele.me/minisearch/result?keyword=${query}`; appUrl = `eleme://search?keyword=${query}`; }
            else if (type === 'meituan') { h5Url = `https://h5.waimai.meituan.com/waimai/mindex/searchresults?keyword=${query}`; appUrl = `imeituan://www.meituan.com/s/${query}`; }
            else { h5Url = `https://m.dianping.com/shoplist/3/search?keyword=${query}`; appUrl = `dianping://searchshoplist?keyword=${query}`; }
            window.open(appUrl, '_blank');
            setTimeout(() => { if (!document.hidden) window.location.href = h5Url; }, 2500);
        }

        const hour = new Date().getHours();
        document.getElementById('meal-time').textContent = hour < 10 ? "æ—©é¤æ—¶é—´" : hour < 14 ? "åˆé¤æ—¶é—´" : hour < 17 ? "ä¸‹åˆèŒ¶æ—¶é—´" : hour < 21 ? "æ™šé¤æ—¶é—´" : "å¤œå®µæ—¶é—´";
        fetchMenus();
    </script>
</body>
</html>
